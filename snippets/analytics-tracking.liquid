{% comment %}
  ANALYTICS TRACKING - Breslev Books
  Agent 9: INTEGRATION & API

  Integrations:
  - Google Analytics 4 (GA4)
  - Facebook Pixel
  - Google Tag Manager (GTM)

  Usage:
  Inclure dans theme.liquid avant </head>:
  {% render 'analytics-tracking' %}
{% endcomment %}

<!-- ========================================
     GOOGLE ANALYTICS 4 (GA4)
     ======================================== -->
{% if settings.ga4_measurement_id != blank %}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ settings.ga4_measurement_id }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  // Configuration de base
  gtag('config', '{{ settings.ga4_measurement_id }}', {
    {% if customer %}
    'user_id': '{{ customer.id }}',
    'user_properties': {
      'customer_type': '{% if customer.orders_count > 0 %}returning{% else %}new{% endif %}',
      'subscription_status': '{{ customer.metafields.subscription.status | default: "none" }}',
      'total_orders': {{ customer.orders_count | default: 0 }},
      'customer_tags': '{{ customer.tags | join: "," }}'
    },
    {% endif %}
    'send_page_view': true
  });

  {% comment %} PAGE VIEW EVENT {% endcomment %}
  gtag('event', 'page_view', {
    'page_title': '{{ page_title | escape }}',
    'page_location': window.location.href,
    'page_path': window.location.pathname,
    'page_type': '{{ template | replace: ".", "-" }}'
  });

  {% comment %} PRODUCT VIEW {% endcomment %}
  {% if template contains 'product' %}
  gtag('event', 'view_item', {
    'currency': '{{ cart.currency.iso_code }}',
    'value': {{ product.price | money_without_currency | remove: ',' }},
    'items': [{
      'item_id': '{{ product.id }}',
      'item_name': '{{ product.title | escape }}',
      'item_brand': '{{ product.vendor | escape }}',
      'item_category': '{{ product.type }}',
      'item_variant': '{{ product.selected_or_first_available_variant.title | escape }}',
      'price': {{ product.price | money_without_currency | remove: ',' }},
      'quantity': 1
    }]
  });
  {% endif %}

  {% comment %} COLLECTION VIEW {% endcomment %}
  {% if template contains 'collection' %}
  gtag('event', 'view_item_list', {
    'item_list_id': '{{ collection.id }}',
    'item_list_name': '{{ collection.title | escape }}',
    'items': [
      {% for product in collection.products limit: 10 %}
      {
        'item_id': '{{ product.id }}',
        'item_name': '{{ product.title | escape }}',
        'item_category': '{{ product.type }}',
        'price': {{ product.price | money_without_currency | remove: ',' }},
        'index': {{ forloop.index }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  });
  {% endif %}

  {% comment %} CART VIEW {% endcomment %}
  {% if template == 'cart' %}
  gtag('event', 'view_cart', {
    'currency': '{{ cart.currency.iso_code }}',
    'value': {{ cart.total_price | money_without_currency | remove: ',' }},
    'items': [
      {% for item in cart.items %}
      {
        'item_id': '{{ item.product_id }}',
        'item_name': '{{ item.product.title | escape }}',
        'item_variant': '{{ item.variant.title | escape }}',
        'price': {{ item.price | money_without_currency | remove: ',' }},
        'quantity': {{ item.quantity }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  });
  {% endif %}

  {% comment %} CHECKOUT EVENTS {% endcomment %}
  {% if first_time_accessed %}
    {% if template == 'cart' %}
    gtag('event', 'begin_checkout', {
      'currency': '{{ cart.currency.iso_code }}',
      'value': {{ cart.total_price | money_without_currency | remove: ',' }},
      'items': [
        {% for item in cart.items %}
        {
          'item_id': '{{ item.product_id }}',
          'item_name': '{{ item.product.title | escape }}',
          'price': {{ item.price | money_without_currency | remove: ',' }},
          'quantity': {{ item.quantity }}
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    });
    {% endif %}
  {% endif %}

  {% comment %} PURCHASE / ORDER CONFIRMATION {% endcomment %}
  {% if template == 'customers/order' or first_time_accessed and checkout.order_id %}
  gtag('event', 'purchase', {
    'transaction_id': '{{ order.order_number }}',
    'value': {{ order.total_price | money_without_currency | remove: ',' }},
    'tax': {{ order.tax_price | money_without_currency | remove: ',' }},
    'shipping': {{ order.shipping_price | money_without_currency | remove: ',' }},
    'currency': '{{ order.currency }}',
    'items': [
      {% for item in order.line_items %}
      {
        'item_id': '{{ item.product_id }}',
        'item_name': '{{ item.product.title | escape }}',
        'item_variant': '{{ item.variant.title | escape }}',
        'price': {{ item.price | money_without_currency | remove: ',' }},
        'quantity': {{ item.quantity }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  });
  {% endif %}
</script>
{% endif %}


<!-- ========================================
     FACEBOOK PIXEL
     ======================================== -->
{% if settings.facebook_pixel_id != blank %}
<!-- Facebook Pixel Code -->
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  fbq('init', '{{ settings.facebook_pixel_id }}');
  fbq('track', 'PageView');

  {% comment %} PRODUCT VIEW {% endcomment %}
  {% if template contains 'product' %}
  fbq('track', 'ViewContent', {
    content_ids: ['{{ product.id }}'],
    content_type: 'product',
    content_name: '{{ product.title | escape }}',
    content_category: '{{ product.type }}',
    value: {{ product.price | money_without_currency | remove: ',' }},
    currency: '{{ cart.currency.iso_code }}'
  });
  {% endif %}

  {% comment %} ADD TO CART {% endcomment %}
  {% if template == 'cart' %}
  fbq('track', 'AddToCart', {
    content_ids: [
      {% for item in cart.items %}
      '{{ item.product_id }}'{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    content_type: 'product',
    value: {{ cart.total_price | money_without_currency | remove: ',' }},
    currency: '{{ cart.currency.iso_code }}'
  });
  {% endif %}

  {% comment %} INITIATE CHECKOUT {% endcomment %}
  {% if first_time_accessed and template == 'cart' %}
  fbq('track', 'InitiateCheckout', {
    content_ids: [
      {% for item in cart.items %}
      '{{ item.product_id }}'{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    num_items: {{ cart.item_count }},
    value: {{ cart.total_price | money_without_currency | remove: ',' }},
    currency: '{{ cart.currency.iso_code }}'
  });
  {% endif %}

  {% comment %} PURCHASE {% endcomment %}
  {% if template == 'customers/order' or checkout.order_id %}
  fbq('track', 'Purchase', {
    content_ids: [
      {% for item in order.line_items %}
      '{{ item.product_id }}'{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    content_type: 'product',
    value: {{ order.total_price | money_without_currency | remove: ',' }},
    currency: '{{ order.currency }}',
    num_items: {{ order.line_items.size }}
  });
  {% endif %}

  {% comment %} SEARCH {% endcomment %}
  {% if template == 'search' %}
  fbq('track', 'Search', {
    search_string: '{{ search.terms | escape }}'
  });
  {% endif %}
</script>
<noscript>
  <img height="1" width="1" style="display:none"
       src="https://www.facebook.com/tr?id={{ settings.facebook_pixel_id }}&ev=PageView&noscript=1"/>
</noscript>
{% endif %}


<!-- ========================================
     GOOGLE TAG MANAGER
     ======================================== -->
{% if settings.gtm_container_id != blank %}
<!-- Google Tag Manager -->
<script>
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','{{ settings.gtm_container_id }}');
</script>

<!-- Data Layer pour GTM -->
<script>
  window.dataLayer = window.dataLayer || [];

  {% comment %} PUSH PAGE DATA {% endcomment %}
  window.dataLayer.push({
    'event': 'pageView',
    'pageType': '{{ template | replace: ".", "-" }}',
    'pageTitle': '{{ page_title | escape }}',
    {% if customer %}
    'customerId': '{{ customer.id }}',
    'customerEmail': '{{ customer.email | escape }}',
    'customerType': '{% if customer.orders_count > 0 %}returning{% else %}new{% endif %}',
    'customerOrdersCount': {{ customer.orders_count | default: 0 }},
    'subscriptionStatus': '{{ customer.metafields.subscription.status | default: "none" }}',
    {% endif %}
    'shopCurrency': '{{ cart.currency.iso_code }}',
    'shopId': '{{ shop.id }}'
  });

  {% comment %} PRODUCT DATA {% endcomment %}
  {% if template contains 'product' %}
  window.dataLayer.push({
    'event': 'productView',
    'ecommerce': {
      'detail': {
        'products': [{
          'id': '{{ product.id }}',
          'name': '{{ product.title | escape }}',
          'price': {{ product.price | money_without_currency | remove: ',' }},
          'brand': '{{ product.vendor | escape }}',
          'category': '{{ product.type }}',
          'variant': '{{ product.selected_or_first_available_variant.title | escape }}'
        }]
      }
    }
  });
  {% endif %}

  {% comment %} CART DATA {% endcomment %}
  {% if template == 'cart' %}
  window.dataLayer.push({
    'event': 'cartView',
    'ecommerce': {
      'cartValue': {{ cart.total_price | money_without_currency | remove: ',' }},
      'cartItemsCount': {{ cart.item_count }},
      'cartProducts': [
        {% for item in cart.items %}
        {
          'id': '{{ item.product_id }}',
          'name': '{{ item.product.title | escape }}',
          'price': {{ item.price | money_without_currency | remove: ',' }},
          'quantity': {{ item.quantity }}
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }
  });
  {% endif %}

  {% comment %} PURCHASE DATA {% endcomment %}
  {% if template == 'customers/order' or checkout.order_id %}
  window.dataLayer.push({
    'event': 'purchase',
    'ecommerce': {
      'purchase': {
        'actionField': {
          'id': '{{ order.order_number }}',
          'revenue': {{ order.total_price | money_without_currency | remove: ',' }},
          'tax': {{ order.tax_price | money_without_currency | remove: ',' }},
          'shipping': {{ order.shipping_price | money_without_currency | remove: ',' }},
          'currency': '{{ order.currency }}'
        },
        'products': [
          {% for item in order.line_items %}
          {
            'id': '{{ item.product_id }}',
            'name': '{{ item.product.title | escape }}',
            'price': {{ item.price | money_without_currency | remove: ',' }},
            'quantity': {{ item.quantity }}
          }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      }
    }
  });
  {% endif %}
</script>
{% endif %}


<!-- ========================================
     CUSTOM EVENTS TRACKING
     ======================================== -->
<script>
  // Helper function pour tracker custom events
  window.trackCustomEvent = function(eventName, eventData) {
    // GA4
    if (typeof gtag !== 'undefined') {
      gtag('event', eventName, eventData);
    }

    // Facebook Pixel
    if (typeof fbq !== 'undefined') {
      fbq('trackCustom', eventName, eventData);
    }

    // GTM Data Layer
    if (window.dataLayer) {
      window.dataLayer.push({
        'event': eventName,
        'eventData': eventData
      });
    }
  };

  // Tracking clicks sur boutons CTA
  document.addEventListener('DOMContentLoaded', function() {
    // Track subscription CTA clicks
    document.querySelectorAll('[data-track="subscription-cta"]').forEach(function(el) {
      el.addEventListener('click', function() {
        trackCustomEvent('subscription_cta_click', {
          'button_text': this.textContent.trim(),
          'page_location': window.location.pathname
        });
      });
    });

    // Track lecteur numerique access
    document.querySelectorAll('[data-track="digital-reader"]').forEach(function(el) {
      el.addEventListener('click', function() {
        trackCustomEvent('digital_reader_access', {
          'book_id': this.dataset.bookId,
          'book_title': this.dataset.bookTitle
        });
      });
    });

    // Track newsletter signup
    const newsletterForm = document.getElementById('newsletter-form');
    if (newsletterForm) {
      newsletterForm.addEventListener('submit', function() {
        trackCustomEvent('newsletter_signup', {
          'form_location': window.location.pathname
        });
      });
    }
  });
</script>

{% comment %}
  USAGE EXAMPLES:

  1. Track custom event from anywhere:
     <button onclick="trackCustomEvent('custom_click', {button: 'my-button'})">
       Click me
     </button>

  2. Track subscription CTA:
     <a href="/abonnement" data-track="subscription-cta">
       S'abonner
     </a>

  3. Track digital reader access:
     <a href="/pages/reader" data-track="digital-reader"
        data-book-id="{{ product.id }}"
        data-book-title="{{ product.title }}">
       Lire maintenant
     </a>
{% endcomment %}
