{% comment %}
  LANGUAGE SWITCHER - Breslev Books
  Agent 9: INTEGRATION & API

  Integration: Weglot Multi-langue (FR/HE/EN)

  Usage:
  {% render 'language-switcher' %}

  Options:
  {% render 'language-switcher', style: 'dropdown' %}
  {% render 'language-switcher', style: 'flags' %}
  {% render 'language-switcher', show_names: true %}
{% endcomment %}

{% assign switcher_style = style | default: 'dropdown' %}
{% assign show_names = show_names | default: true %}

{% comment %} Detecter la langue actuelle {% endcomment %}
{% assign current_locale = request.locale.iso_code | default: 'fr' %}

{% comment %} Langues disponibles {% endcomment %}
{% assign available_locales = shop.published_locales %}

<div class="language-switcher language-switcher-{{ switcher_style }}" data-style="{{ switcher_style }}">
  {% if switcher_style == 'dropdown' %}
    <!-- DROPDOWN STYLE -->
    <button class="language-current" id="lang-btn-{{ section.id }}" aria-label="Choisir la langue">
      <span class="lang-flag">
        {% render 'icon-flag', locale: current_locale %}
      </span>
      {% if show_names %}
        <span class="lang-name">
          {% case current_locale %}
            {% when 'fr' %}Francais
            {% when 'he' %}עברית
            {% when 'en' %}English
            {% else %}{{ current_locale | upcase }}
          {% endcase %}
        </span>
      {% else %}
        <span class="lang-code">{{ current_locale | upcase }}</span>
      {% endif %}
      <svg class="lang-arrow" width="12" height="8" viewBox="0 0 12 8">
        <path d="M1 1l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="language-dropdown" id="lang-dropdown-{{ section.id }}" style="display: none;">
      {% for locale in available_locales %}
        {% unless locale.iso_code == current_locale %}
          <a
            href="{{ request.path | append: '?locale=' | append: locale.iso_code }}"
            class="lang-option"
            hreflang="{{ locale.iso_code }}"
          >
            <span class="lang-flag">
              {% render 'icon-flag', locale: locale.iso_code %}
            </span>
            <span class="lang-name">
              {% case locale.iso_code %}
                {% when 'fr' %}Francais
                {% when 'he' %}עברית
                {% when 'en' %}English
                {% else %}{{ locale.name }}
              {% endcase %}
            </span>
          </a>
        {% endunless %}
      {% endfor %}
    </div>

  {% elsif switcher_style == 'flags' %}
    <!-- FLAGS STYLE -->
    <div class="language-flags">
      {% for locale in available_locales %}
        <a
          href="{{ request.path | append: '?locale=' | append: locale.iso_code }}"
          class="lang-flag-link {% if locale.iso_code == current_locale %}active{% endif %}"
          hreflang="{{ locale.iso_code }}"
          title="{% case locale.iso_code %}{% when 'fr' %}Francais{% when 'he' %}עברית{% when 'en' %}English{% else %}{{ locale.name }}{% endcase %}"
        >
          {% render 'icon-flag', locale: locale.iso_code %}
          {% if show_names %}
            <span class="flag-name">{{ locale.iso_code | upcase }}</span>
          {% endif %}
        </a>
      {% endfor %}
    </div>

  {% elsif switcher_style == 'inline' %}
    <!-- INLINE STYLE -->
    <div class="language-inline">
      {% for locale in available_locales %}
        <a
          href="{{ request.path | append: '?locale=' | append: locale.iso_code }}"
          class="lang-inline-link {% if locale.iso_code == current_locale %}active{% endif %}"
          hreflang="{{ locale.iso_code }}"
        >
          {{ locale.iso_code | upcase }}
        </a>
        {% unless forloop.last %}
          <span class="lang-separator">|</span>
        {% endunless %}
      {% endfor %}
    </div>
  {% endif %}
</div>

{% comment %} FLAG ICONS SNIPPET {% endcomment %}
{% comment %}
  Snippet: icon-flag.liquid
  Usage: {% render 'icon-flag', locale: 'fr' %}
{% endcomment %}
{% capture flag_icon %}
  {% case locale %}
    {% when 'fr' %}
      <!-- Flag France -->
      <svg class="flag-icon" width="24" height="16" viewBox="0 0 24 16">
        <rect width="8" height="16" fill="#002395"/>
        <rect x="8" width="8" height="16" fill="#FFFFFF"/>
        <rect x="16" width="8" height="16" fill="#ED2939"/>
      </svg>

    {% when 'he' %}
      <!-- Flag Israel -->
      <svg class="flag-icon" width="24" height="16" viewBox="0 0 24 16">
        <rect width="24" height="16" fill="#FFFFFF"/>
        <rect y="2" width="24" height="2" fill="#0038B8"/>
        <rect y="12" width="24" height="2" fill="#0038B8"/>
        <path d="M12 4L14 8L12 12L10 8Z" fill="none" stroke="#0038B8" stroke-width="0.5"/>
        <path d="M12 8L14 4L10 4Z" fill="none" stroke="#0038B8" stroke-width="0.5"/>
        <path d="M12 8L14 12L10 12Z" fill="none" stroke="#0038B8" stroke-width="0.5"/>
      </svg>

    {% when 'en' %}
      <!-- Flag UK -->
      <svg class="flag-icon" width="24" height="16" viewBox="0 0 24 16">
        <rect width="24" height="16" fill="#012169"/>
        <path d="M0 0L24 16M24 0L0 16" stroke="#FFFFFF" stroke-width="3"/>
        <path d="M0 0L24 16M24 0L0 16" stroke="#C8102E" stroke-width="2"/>
        <path d="M12 0V16M0 8H24" stroke="#FFFFFF" stroke-width="5"/>
        <path d="M12 0V16M0 8H24" stroke="#C8102E" stroke-width="3"/>
      </svg>

    {% else %}
      <!-- Default flag icon -->
      <svg class="flag-icon" width="24" height="16" viewBox="0 0 24 16">
        <rect width="24" height="16" fill="#CCCCCC" stroke="#999999"/>
      </svg>
  {% endcase %}
{% endcapture %}

{{ flag_icon }}

<style>
/* ===========================
   LANGUAGE SWITCHER STYLES
   =========================== */

.language-switcher {
  position: relative;
  display: inline-block;
}

/* DROPDOWN STYLE */
.language-current {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border: 1px solid #e2e8f0;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.language-current:hover {
  border-color: #2c5282;
  background: #f7fafc;
}

.lang-flag {
  display: flex;
  align-items: center;
}

.flag-icon {
  width: 24px;
  height: 16px;
  border: 1px solid #e2e8f0;
  border-radius: 2px;
}

.lang-name,
.lang-code {
  font-weight: 500;
  color: #2d3748;
}

.lang-arrow {
  margin-left: auto;
  transition: transform 0.3s ease;
}

.language-current.active .lang-arrow {
  transform: rotate(180deg);
}

.language-dropdown {
  position: absolute;
  top: calc(100% + 5px);
  right: 0;
  min-width: 150px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  overflow: hidden;
}

.lang-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 15px;
  text-decoration: none;
  color: #2d3748;
  transition: background 0.2s ease;
}

.lang-option:hover {
  background: #f7fafc;
}

/* FLAGS STYLE */
.language-flags {
  display: flex;
  align-items: center;
  gap: 10px;
}

.lang-flag-link {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  text-decoration: none;
  opacity: 0.6;
  transition: opacity 0.3s ease;
}

.lang-flag-link:hover,
.lang-flag-link.active {
  opacity: 1;
}

.flag-name {
  font-size: 11px;
  font-weight: 600;
  color: #2d3748;
}

/* INLINE STYLE */
.language-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.lang-inline-link {
  color: #4a5568;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.3s ease;
}

.lang-inline-link:hover,
.lang-inline-link.active {
  color: #2c5282;
}

.lang-separator {
  color: #cbd5e0;
}

/* RTL Support pour Hebreu */
html[dir="rtl"] .language-current {
  flex-direction: row-reverse;
}

html[dir="rtl"] .language-dropdown {
  right: auto;
  left: 0;
}

html[dir="rtl"] .lang-option {
  flex-direction: row-reverse;
}

/* Responsive */
@media (max-width: 768px) {
  .language-current {
    padding: 6px 10px;
    font-size: 13px;
  }

  .flag-icon {
    width: 20px;
    height: 14px;
  }

  .language-dropdown {
    min-width: 120px;
  }

  .lang-option {
    padding: 8px 12px;
  }
}
</style>

<script>
(function() {
  const langBtn = document.getElementById('lang-btn-{{ section.id }}');
  const langDropdown = document.getElementById('lang-dropdown-{{ section.id }}');

  if (langBtn && langDropdown) {
    // Toggle dropdown
    langBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      const isOpen = langDropdown.style.display === 'block';

      if (isOpen) {
        langDropdown.style.display = 'none';
        langBtn.classList.remove('active');
      } else {
        langDropdown.style.display = 'block';
        langBtn.classList.add('active');
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!langBtn.contains(e.target) && !langDropdown.contains(e.target)) {
        langDropdown.style.display = 'none';
        langBtn.classList.remove('active');
      }
    });

    // Close dropdown on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && langDropdown.style.display === 'block') {
        langDropdown.style.display = 'none';
        langBtn.classList.remove('active');
      }
    });
  }

  // Set HTML direction for RTL languages
  const currentLocale = '{{ current_locale }}';
  if (currentLocale === 'he' || currentLocale === 'ar') {
    document.documentElement.setAttribute('dir', 'rtl');
  } else {
    document.documentElement.setAttribute('dir', 'ltr');
  }

  // Save language preference
  const langLinks = document.querySelectorAll('.language-switcher a');
  langLinks.forEach(link => {
    link.addEventListener('click', function() {
      const locale = this.getAttribute('hreflang');
      if (locale) {
        localStorage.setItem('preferred_language', locale);

        // Track language change
        if (window.trackCustomEvent) {
          window.trackCustomEvent('language_changed', {
            from: currentLocale,
            to: locale
          });
        }
      }
    });
  });
})();
</script>

{% comment %}
  WEGLOT INTEGRATION SCRIPT
  A inclure dans theme.liquid avant </head>
{% endcomment %}
{% if settings.weglot_api_key != blank %}
<script type="text/javascript" src="https://cdn.weglot.com/weglot.min.js"></script>
<script>
  Weglot.initialize({
    api_key: '{{ settings.weglot_api_key }}',
    originalLanguage: 'fr',
    destinationLanguages: 'he,en',
    {% if settings.weglot_auto_translate %}
    autoSwitch: true,
    {% endif %}
    cache: true,
    switchers: [{
      styleOpt: {
        fullname: {{ show_names | json }},
        withname: {{ show_names | json }},
        is_dropdown: {% if switcher_style == 'dropdown' %}true{% else %}false{% endif %},
        with_flags: true
      },
      location: {
        target: '.language-switcher',
        sibling: null
      }
    }]
  });
</script>
{% endif %}

{% comment %}
  CSS RTL SUPPORT
  A ajouter dans assets/breslev-main.css
{% endcomment %}
<style>
/* RTL Support pour Hebreu */
html[dir="rtl"] {
  direction: rtl;
  text-align: right;
}

html[dir="rtl"] body {
  text-align: right;
}

/* Inverser flex direction */
html[dir="rtl"] .header-main,
html[dir="rtl"] .footer-main,
html[dir="rtl"] .book-card {
  flex-direction: row-reverse;
}

/* Inverser marges et paddings */
html[dir="rtl"] .ml-1 { margin-left: 0; margin-right: 0.25rem; }
html[dir="rtl"] .ml-2 { margin-left: 0; margin-right: 0.5rem; }
html[dir="rtl"] .ml-3 { margin-left: 0; margin-right: 0.75rem; }
html[dir="rtl"] .ml-4 { margin-left: 0; margin-right: 1rem; }

html[dir="rtl"] .mr-1 { margin-right: 0; margin-left: 0.25rem; }
html[dir="rtl"] .mr-2 { margin-right: 0; margin-left: 0.5rem; }
html[dir="rtl"] .mr-3 { margin-right: 0; margin-left: 0.75rem; }
html[dir="rtl"] .mr-4 { margin-right: 0; margin-left: 1rem; }

html[dir="rtl"] .pl-1 { padding-left: 0; padding-right: 0.25rem; }
html[dir="rtl"] .pl-2 { padding-left: 0; padding-right: 0.5rem; }
html[dir="rtl"] .pl-3 { padding-left: 0; padding-right: 0.75rem; }
html[dir="rtl"] .pl-4 { padding-left: 0; padding-right: 1rem; }

html[dir="rtl"] .pr-1 { padding-right: 0; padding-left: 0.25rem; }
html[dir="rtl"] .pr-2 { padding-right: 0; padding-left: 0.5rem; }
html[dir="rtl"] .pr-3 { padding-right: 0; padding-left: 0.75rem; }
html[dir="rtl"] .pr-4 { padding-right: 0; padding-left: 1rem; }

/* Text alignment */
html[dir="rtl"] .text-left { text-align: right; }
html[dir="rtl"] .text-right { text-align: left; }

/* Icons */
html[dir="rtl"] .icon-arrow-right { transform: scaleX(-1); }
html[dir="rtl"] .icon-arrow-left { transform: scaleX(-1); }
</style>

{% comment %}
  SCHEMA POUR SECTION (Optionnel)

  {% schema %}
  {
    "name": "Language Switcher",
    "settings": [
      {
        "type": "select",
        "id": "switcher_style",
        "label": "Style",
        "options": [
          {
            "value": "dropdown",
            "label": "Dropdown"
          },
          {
            "value": "flags",
            "label": "Drapeaux"
          },
          {
            "value": "inline",
            "label": "Inline"
          }
        ],
        "default": "dropdown"
      },
      {
        "type": "checkbox",
        "id": "show_names",
        "label": "Afficher noms des langues",
        "default": true
      }
    ],
    "presets": [
      {
        "name": "Language Switcher"
      }
    ]
  }
  {% endschema %}
{% endcomment %}
