{% comment %}
  NEWSLETTER FORM - Breslev Books
  Agent 9: INTEGRATION & API

  Integration: Klaviyo Email Marketing

  Usage:
  {% render 'newsletter-form' %}

  Options:
  {% render 'newsletter-form', style: 'inline' %}
  {% render 'newsletter-form', style: 'popup' %}
  {% render 'newsletter-form', show_privacy: true %}
{% endcomment %}

{% assign form_style = style | default: 'default' %}
{% assign show_privacy = show_privacy | default: false %}

<div class="newsletter-wrapper newsletter-{{ form_style }}">
  <div class="newsletter-container">
    {% if form_style == 'default' %}
      <div class="newsletter-header">
        <h3 class="newsletter-title">{{ section.settings.newsletter_title | default: 'Restez informes' }}</h3>
        <p class="newsletter-description">
          {{ section.settings.newsletter_description | default: 'Recevez nos nouvelles publications et offres exclusives' }}
        </p>
      </div>
    {% endif %}

    <form id="newsletter-form-{{ section.id }}" class="newsletter-form" novalidate>
      <div class="newsletter-inputs">
        {% if form_style != 'inline' %}
          <div class="form-group">
            <label for="newsletter-name" class="form-label">
              Prenom
            </label>
            <input
              type="text"
              id="newsletter-name"
              name="first_name"
              placeholder="Votre prenom"
              class="form-input"
            />
          </div>
        {% endif %}

        <div class="form-group">
          {% if form_style != 'inline' %}
            <label for="newsletter-email" class="form-label">
              Email <span class="required">*</span>
            </label>
          {% endif %}
          <input
            type="email"
            id="newsletter-email"
            name="email"
            placeholder="votre@email.com"
            class="form-input"
            required
          />
        </div>

        <button type="submit" class="newsletter-submit">
          <span class="submit-text">S'inscrire</span>
          <span class="submit-loading" style="display: none;">
            <svg class="spinner" width="20" height="20" viewBox="0 0 20 20">
              <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none" />
            </svg>
          </span>
        </button>
      </div>

      {% if show_privacy %}
        <div class="newsletter-privacy">
          <label class="privacy-checkbox">
            <input type="checkbox" name="privacy_accepted" required />
            <span>
              J'accepte de recevoir des emails marketing.
              <a href="/pages/privacy-policy" target="_blank">Politique de confidentialite</a>
            </span>
          </label>
        </div>
      {% endif %}
    </form>

    <div id="newsletter-message-{{ section.id }}" class="newsletter-message"></div>

    {% if form_style == 'default' %}
      <div class="newsletter-benefits">
        <div class="benefit-item">
          <svg class="benefit-icon" width="20" height="20" viewBox="0 0 20 20">
            <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-2 15l-5-5 1.41-1.41L8 12.17l7.59-7.59L17 6l-9 9z" fill="currentColor"/>
          </svg>
          <span>Nouvelles publications en avant-premiere</span>
        </div>
        <div class="benefit-item">
          <svg class="benefit-icon" width="20" height="20" viewBox="0 0 20 20">
            <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-2 15l-5-5 1.41-1.41L8 12.17l7.59-7.59L17 6l-9 9z" fill="currentColor"/>
          </svg>
          <span>Offres exclusives reserves aux abonnes</span>
        </div>
        <div class="benefit-item">
          <svg class="benefit-icon" width="20" height="20" viewBox="0 0 20 20">
            <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-2 15l-5-5 1.41-1.41L8 12.17l7.59-7.59L17 6l-9 9z" fill="currentColor"/>
          </svg>
          <span>Contenus spirituels gratuits chaque semaine</span>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<style>
/* ===========================
   NEWSLETTER FORM STYLES
   =========================== */

.newsletter-wrapper {
  width: 100%;
  padding: 40px 20px;
}

.newsletter-wrapper.newsletter-default {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

.newsletter-wrapper.newsletter-inline {
  background: transparent;
  padding: 20px 0;
}

.newsletter-container {
  max-width: 600px;
  margin: 0 auto;
}

.newsletter-header {
  text-align: center;
  margin-bottom: 30px;
}

.newsletter-title {
  font-size: 28px;
  font-weight: 700;
  color: #2c5282;
  margin-bottom: 10px;
}

.newsletter-description {
  font-size: 16px;
  color: #4a5568;
  margin: 0;
}

/* Form */
.newsletter-form {
  margin-bottom: 20px;
}

.newsletter-inputs {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.newsletter-inline .newsletter-inputs {
  flex-direction: row;
  gap: 10px;
}

.form-group {
  flex: 1;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 5px;
}

.form-label .required {
  color: #e53e3e;
}

.form-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  font-size: 15px;
  transition: all 0.3s ease;
  background: white;
}

.form-input:focus {
  outline: none;
  border-color: #2c5282;
  box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
}

.form-input::placeholder {
  color: #a0aec0;
}

.newsletter-submit {
  padding: 12px 30px;
  background: #2c5282;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.newsletter-submit:hover {
  background: #1a365d;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(44, 82, 130, 0.3);
}

.newsletter-submit:active {
  transform: translateY(0);
}

.newsletter-submit.loading {
  opacity: 0.7;
  cursor: not-allowed;
}

.submit-loading {
  display: inline-flex;
  align-items: center;
}

/* Spinner animation */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.spinner {
  animation: spin 1s linear infinite;
}

/* Privacy */
.newsletter-privacy {
  margin-top: 15px;
}

.privacy-checkbox {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 13px;
  color: #4a5568;
  cursor: pointer;
}

.privacy-checkbox input[type="checkbox"] {
  margin-top: 3px;
  cursor: pointer;
}

.privacy-checkbox a {
  color: #2c5282;
  text-decoration: underline;
}

/* Message */
.newsletter-message {
  padding: 12px 16px;
  border-radius: 6px;
  font-size: 14px;
  display: none;
  margin-top: 15px;
}

.newsletter-message.success {
  display: block;
  background: #c6f6d5;
  color: #22543d;
  border: 1px solid #9ae6b4;
}

.newsletter-message.error {
  display: block;
  background: #fed7d7;
  color: #742a2a;
  border: 1px solid #fc8181;
}

/* Benefits */
.newsletter-benefits {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.benefit-item {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  color: #2d3748;
}

.benefit-icon {
  flex-shrink: 0;
  color: #48bb78;
}

/* Responsive */
@media (max-width: 768px) {
  .newsletter-wrapper {
    padding: 30px 15px;
  }

  .newsletter-title {
    font-size: 24px;
  }

  .newsletter-inline .newsletter-inputs {
    flex-direction: column;
  }

  .newsletter-submit {
    width: 100%;
  }
}
</style>

<script>
(function() {
  const form = document.getElementById('newsletter-form-{{ section.id }}');
  const messageDiv = document.getElementById('newsletter-message-{{ section.id }}');
  const submitBtn = form.querySelector('.newsletter-submit');

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Reset message
    messageDiv.className = 'newsletter-message';
    messageDiv.style.display = 'none';

    // Get form data
    const email = form.email.value.trim();
    const firstName = form.first_name ? form.first_name.value.trim() : '';

    // Validation
    if (!email || !isValidEmail(email)) {
      showMessage('Veuillez entrer une adresse email valide.', 'error');
      return;
    }

    {% if show_privacy %}
    if (form.privacy_accepted && !form.privacy_accepted.checked) {
      showMessage('Veuillez accepter la politique de confidentialite.', 'error');
      return;
    }
    {% endif %}

    // Show loading
    submitBtn.classList.add('loading');
    submitBtn.querySelector('.submit-text').style.display = 'none';
    submitBtn.querySelector('.submit-loading').style.display = 'inline-flex';

    try {
      {% if settings.klaviyo_api_key != blank %}
      // Klaviyo integration
      const response = await fetch('https://a.klaviyo.com/api/v2/list/{{ settings.klaviyo_list_id }}/subscribe', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          api_key: '{{ settings.klaviyo_api_key }}',
          profiles: [{
            email: email,
            {% if firstName != '' %}
            '$first_name': firstName,
            {% endif %}
            properties: {
              '$source': 'Breslev Books Newsletter',
              'signup_page': window.location.pathname,
              'signup_date': new Date().toISOString()
            }
          }]
        })
      });

      if (response.ok) {
        showMessage('Merci! Vous etes maintenant inscrit a notre newsletter.', 'success');
        form.reset();

        // Track event
        if (window.trackCustomEvent) {
          window.trackCustomEvent('newsletter_signup', {
            email: email,
            source: 'newsletter_form',
            page: window.location.pathname
          });
        }
      } else {
        throw new Error('Erreur inscription');
      }
      {% else %}
      // Fallback si pas de Klaviyo configure
      console.warn('Klaviyo API key non configuree');
      showMessage('Configuration en cours. Veuillez reessayer plus tard.', 'error');
      {% endif %}
    } catch (error) {
      console.error('Newsletter error:', error);
      showMessage('Une erreur est survenue. Veuillez reessayer.', 'error');
    } finally {
      // Hide loading
      submitBtn.classList.remove('loading');
      submitBtn.querySelector('.submit-text').style.display = 'inline';
      submitBtn.querySelector('.submit-loading').style.display = 'none';
    }
  });

  function showMessage(text, type) {
    messageDiv.textContent = text;
    messageDiv.className = 'newsletter-message ' + type;
    messageDiv.style.display = 'block';

    // Auto-hide after 5 seconds
    if (type === 'success') {
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }
})();
</script>

{% comment %}
  SCHEMA POUR SECTION (Optionnel)
  Si utilise comme section, ajouter ce schema:

  {% schema %}
  {
    "name": "Newsletter Form",
    "settings": [
      {
        "type": "text",
        "id": "newsletter_title",
        "label": "Titre",
        "default": "Restez informes"
      },
      {
        "type": "textarea",
        "id": "newsletter_description",
        "label": "Description",
        "default": "Recevez nos nouvelles publications et offres exclusives"
      },
      {
        "type": "select",
        "id": "form_style",
        "label": "Style du formulaire",
        "options": [
          {
            "value": "default",
            "label": "Complet avec benefits"
          },
          {
            "value": "inline",
            "label": "Inline simple"
          }
        ],
        "default": "default"
      },
      {
        "type": "checkbox",
        "id": "show_privacy",
        "label": "Afficher checkbox RGPD",
        "default": false
      }
    ],
    "presets": [
      {
        "name": "Newsletter Form"
      }
    ]
  }
  {% endschema %}
{% endcomment %}
