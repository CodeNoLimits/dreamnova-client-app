{% comment %} 
  Protection DRM Sociale avec LemonInk
  Watermarking invisible sur chaque PDF
{% endcomment %}

<script>
// Configuration LemonInk pour watermarking
window.LemonInk = {
  apiKey: '{{ settings.lemonink_api_key }}',
  
  protectPDF: async function(pdfUrl, customerData) {
    const response = await fetch('https://api.lemonink.co/v1/protect', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        source_url: pdfUrl,
        watermark: {
          // Watermark visible
          visible: {
            text: `Achet√© par: ${customerData.name}
Email: ${customerData.email}
Commande: #${customerData.order_number}`,
            position: 'bottom-right',
            opacity: 0.4,
            fontSize: 10,
            color: '#666666'
          },
          
          // Watermark invisible (forensique)
          invisible: {
            customer_id: customerData.id,
            purchase_date: new Date().toISOString(),
            ip_address: customerData.ip,
            fingerprint: await this.generateFingerprint()
          }
        },
        
        // Restrictions
        restrictions: {
          printing: false,
          copying: false,
          modification: false,
          assembly: false,
          forms: false,
          annotations: true // Permettre les notes
        },
        
        // Expiration (optionnel pour location)
        expiration: customerData.rental ? {
          days: 30,
          message: 'Cette location a expir√©. Veuillez renouveler.'
        } : null
      })
    });
    
    const data = await response.json();
    return data.protected_url;
  },
  
  generateFingerprint: async function() {
    // Cr√©er empreinte unique du navigateur
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Esther Ifrah ¬© 2025', 2, 2);
    return canvas.toDataURL();
  }
};
</script>

{% if customer and product.type == 'digital' %}
  <div id="drm-notice" class="drm-notice">
    <p>üìî Ce livre num√©rique est prot√©g√© par DRM sociale</p>
    <p>Il est personnalis√© pour: <strong>{{ customer.email }}</strong></p>
    <p>‚ö†Ô∏è Le partage non autoris√© est interdit et tra√ßable</p>
    <p><small>¬© Esther Ifrah - Enseignements Breslev</small></p>
  </div>
  
  <style>
  .drm-notice {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    text-align: center;
  }
  
  .drm-notice p {
    margin: 5px 0;
    color: #856404;
  }
  </style>
{% endif %}

